---
layout: post
title: "关于持续集成环境的思考"
category: "技术"
tags: ["持续集成"]
---

## CI为何物

    持续集成(以下简称CI)是当代码提交后，系统自动更新到最新代码并执行预先写好的测试，从而验证功能的正确性的一个过程。

    在这个里面，会有UT(单元测试)，IT(集成测试)以及FT(功能测试)来保证代码功能的正确性和功能的完整性，还会有各种checkstyle plugins，如jslint来检查javascript代码的规范等。如果这些测试中的任何一个部分出问题就会引起整个持续集成系统挂掉，这样就会提醒开发人员及时对错误进行修正。如果没有及时修，就会影响其他人的进度，大家有码无法push，就会拖垮整个开发进度。如果硬着头皮push上去，更会导致不可预期的后果。

## 谈一谈最近在项目中修CI的体会。

    我们接手的是一个互联网项目，用java和ruby实现，spring-mvc框架，gradle/groovy做动态构建脚本，junit和cucumber做UT和FT。整个CI的
pipeline是主从式(master/slave)分布，挂在jenkins服务器上，先由master节点build出package，在同时trigger子任务根据此包跑功能测试，回归
测试。这次的主要修改可以说是顺应潮流的改动，把一个庞大无比的系统拆分成高内聚低耦合的模块，俗称micro service。这种系统的结构图就是很分散的服务
模块，让人乍看有些晕。虽说高内聚低耦合，但由于服务与服务之间的通信从来都是通过http协议交流信息，这会让系统之间的集成测试和功能测试很难进行。不出
意外的挂掉了build，但在每次push之后只能紧张的等待让我不由开始思考，这个build可不可以优化下，可不可以更迅速的反馈，可不可以实现并行操作。

    先说CI要达到的目的：

        1) 让系统更鲁棒
        2) 继续在新代码上开发时充满信心
        3) 减少出现bug的风险，让新功能与遗留代码和谐相处

现CI已经可以保证达到以上几点目的，但随着提交代码越来越多，功能越来越复杂，结构越来越分散，为了让CI更加轻量，反应快速，经过思考后我得到以下可以优化的地方：

    1) 让slave节点同时执行本来就可以并发的任务，这样可以很大程度缩短build的时间。比如两个毫无业务联系的功能块，就可以拆分出来让他们同时跑测试。
       不足：a. 需要增加虚拟机，成本增高。如果换成bamboo则会比jenkins慢3倍以上(项目中jenkins是本地虚拟机，bamboo采用AWS)
            b. 如果单个build失败则需要重新push，重新trigger整个build
    2) 支持智能提交，比如，如果只是提交jsp或者css的代码，那就没有跑java的unit test的必要，如果只是提交后台代码，则没有必要跑jasmine，以此类推。
       不足：需要找出没有关联的业务和测试代码。
    3) 减少服务模块之间的通信成本，如果没有用mock对依赖的服务进行仿真模拟，那么就需要把依赖的服务全部启动在本地环境，这样可以最大程度的降低通讯成本。
       不足：本地服务会越来越多，每次跑build都要更新各种依赖，各种依赖的版本控制也成问题。
    4) 删除没有必要出现的测试，众所周知测试框架好比一个金字塔，最底层是大量的单元测试，往上走是集成测试，再往上走是功能测试，最上面则是用户，测试，一层比一层窄，一层比一层测试少，尽量把测试往单元测试里推，尽可能多的减少功能测试，功能测试的成本最高，平均每一个cucumber测试需要10s左右的时间。
       不足：需要大量的时间分析每次测试的目的，需要了解业务关系的开发人员参与。

    以上建议可以逐步实现，先将测试并发，在建立好的依赖管理，将micro service全部启动在CI本地，再删除没有必要的测试，最后添加只能CI逻辑。这样相信
在等build时也许会少些痛苦。

{% include JB/setup %}
